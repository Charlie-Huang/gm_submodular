'''
 Implementation of the objectives used in
 M. Gygli, H. Grabner, L. Van Gool - Video Summarization by learning submodular mixtures of objectives. CVPR 2015
'''
__author__ = "Michael Gygli"
__maintainer__ = "Michael Gygli"
__email__ = "gygli@vision.ee.ethz.ch"

import numpy as np
from IPython.core.debugger import Tracer
def representativeness_shell(S):
    '''
        Representativeness shell Eq. (8)
    :param S: DataElement with function getDistances()
    :return: representativeness objective
    '''
    tempDMat=S.getDistances()
    norm=tempDMat.mean()
    return (lambda X: (1 - kmedoid_loss(X,tempDMat,float(norm))))

def kmedoid_loss(X,distMat,norm):
    '''
    Implements Eq (7)

    :param X: selected indices
    :param distMat: distance matrix
    :param norm: normalizer. defined the distance to the phantom element
    :return: k-medoid loss
    '''
    if len(X)>0:
        min_dist=distMat[:,X].min(axis=1)
        min_dist[min_dist>norm] = norm
        return min_dist.mean()/norm
    else:
        return 1

def random_shell(S):
    '''
     Random shell (to check noise sensitivity).
     Assigns each element in S.Y a random value.
     The score of a solution is the sum over the random values of this solution
    :param S: DataElement
    :return: random objective
    '''
    #np.random.seed(0)
    rand_scores=np.random.rand(len(S.Y))
    return (lambda X: np.sum(rand_scores[X]) /  S.budget)


def earliness_shell(S):
    '''
    :param S: DataElement
    :return: earliness objective
    '''
    return (lambda X: (np.max(S.Y)*len(X) - np.sum(S.Y[X]))/float(S.budget*np.max(S.Y)))


def web_score(S):
    web_int=np.copy(S.web_int)
    web_int=web_int-min(web_int)    
    web_int=np.nan_to_num(web_int)
    web_int=web_int/max(web_int)    
    #web_int[web_int<0.5]=0
    indices=(-S.web_int).argsort()
    max_int=web_int[indices[0:len(S.y_gt)]].sum()
    #Tracer()()
    return (lambda X: (getInt(X,web_int)/ max_int))

def getInt(X,int_scores):
    sum_int=int_scores[np.array(X)].sum()
    return sum_int